import { YesOrNo } from '@approved-premises/ui'
import { itShouldHaveNextValue, itShouldHavePreviousValue } from '../../../shared-examples'

import Vulnerability from './vulnerability'
import applicationFactory from '../../../../testutils/factories/application'
import personFactory from '../../../../testutils/factories/person'

describe('Vulnerability', () => {
  const person = personFactory.build({ name: 'John Wayne' })
  const application = applicationFactory.build({ person })

  const body = {
    exploitable: 'yes' as YesOrNo,
    exploitableDetail: 'Risk to staff detail',
    exploitOthers: 'yes' as YesOrNo,
    exploitOthersDetail: 'Exploit others detail',
  }

  describe('questions', () => {
    it("adds the person's name to the question titles", () => {
      const page = new Vulnerability(body, application)

      expect(page.questions).toEqual({
        exploitOthers: 'Is there any evidence or expectation that John Wayne may groom, radicalise or exploit others?',
        exploitable: 'Are you aware that John Wayne is vulnerable to exploitation from others?',
      })
    })
  })

  describe('body', () => {
    it('should set the body', () => {
      const page = new Vulnerability(body, application)

      expect(page.body).toEqual(body)
    })
  })

  itShouldHaveNextValue(new Vulnerability(body, application), 'previous-placements')
  itShouldHavePreviousValue(new Vulnerability(body, application), 'room-sharing')

  describe('errors', () => {
    it('should return errors when yes/no questions are blank', () => {
      const page = new Vulnerability({}, application)

      expect(page.errors()).toEqual({
        exploitOthers:
          'You must specify if there is any evidence or expectation that John Wayne may groom, radicalise or exploit others',
        exploitable: 'You must specify if you are aware that John Wayne is vulnerable to exploitation from others',
      })
    })

    it('shows errors when a question has a yes response, but the details are left out', () => {
      const page = new Vulnerability({ ...body, exploitOthersDetail: '' }, application)

      expect(page.errors()).toEqual({
        exploitOthersDetail:
          'You must specify details about if there is any evidence or expectation that John Wayne may groom, radicalise or exploit others',
      })
    })
  })

  describe('response', () => {
    it('Adds detail to an answer when the answer is yes', () => {
      const page = new Vulnerability(body, application)

      expect(page.response()).toEqual({
        'Are you aware that John Wayne is vulnerable to exploitation from others?': 'Yes - Risk to staff detail',
        'Is there any evidence or expectation that John Wayne may groom, radicalise or exploit others?':
          'Yes - Exploit others detail',
      })
    })

    it('does not add detail to questions with a no answer', () => {
      body.exploitOthers = 'no'

      const page = new Vulnerability(body, application)

      expect(page.response()).toEqual({
        'Are you aware that John Wayne is vulnerable to exploitation from others?': 'Yes - Risk to staff detail',
        'Is there any evidence or expectation that John Wayne may groom, radicalise or exploit others?': 'No',
      })
    })
  })
})
